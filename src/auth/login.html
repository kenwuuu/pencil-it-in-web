<!doctype html>
<html class="h-full bg-white" lang="en">
  <head>
    <meta
      charset="UTF-8"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover, initial-scale=1.0,
      minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
      name="viewport"
    />
    <title>Pencil It In</title>
  </head>
  <body class="h-full">
    <div class="flex min-h-full flex-col justify-center px-6 py-12 lg:px-8">
      <div class="sm:mx-auto sm:w-full sm:max-w-sm">
        <img
          alt="Your Company"
          class="mx-auto h-10 w-auto"
          src="https://tailwindcss.com/plus-assets/img/logos/mark.svg?color=indigo&shade=600"
        />
        <h2
          class="mt-10 text-center text-2xl/9 font-bold tracking-tight text-gray-900"
        >
          Log in to your account
        </h2>
      </div>

      <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
        <form action="#" class="space-y-6" method="POST" novalidate>
          <div>
            <label class="block text-sm/6 font-medium text-gray-900" for="email"
              >Email address</label
            >
            <div class="mt-2 input-container">
              <input
                autocomplete="email"
                class="input-field block w-full px-4 py-3 text-gray-900 placeholder:text-gray-400 focus:outline-none"
                id="email"
                name="email"
                required
                type="email"
              />
            </div>
            <div id="emailError" class="error-message"></div>
            <div id="emailSuccess" class="success-message"></div>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <label
                class="block text-sm/6 font-medium text-gray-900"
                for="password"
                >Password</label
              >
              <div class="text-sm">
                <a
                  class="font-semibold text-indigo-600 hover:text-indigo-500"
                  href="#"
                  >Forgot password?</a
                >
              </div>
            </div>
            <div class="mt-2 input-container relative">
              <input
                autocomplete="current-password"
                class="input-field block w-full px-4 py-3 text-gray-900 placeholder:text-gray-400 focus:outline-none"
                id="password"
                name="password"
                required
                type="password"
              />
              <svg
                id="togglePassword"
                class="input-icon absolute right-[12px] top-[50%] translate-[-50%] w-[20px] h-[20px] cursor-pointer text-indigo-500 hover:text-indigo-600 transition-colors duration-200 ease-in-out"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
              >
                <path
                  id="eyeOpen"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  id="eyeOpen2"
                  d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  id="eyeClosed"
                  class="hidden"
                  d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </div>
            <div id="passwordError" class="error-message"></div>
            <div id="passwordSuccess" class="success-message"></div>
          </div>

          <div>
            <button
              class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
              type="submit"
            >
              Log in
            </button>
          </div>
        </form>

        <p class="mt-3 text-center text-sm/6 text-gray-500">
          <a
            class="font-semibold text-indigo-600 hover:text-indigo-500"
            href="/src/auth/create-account.html"
            >Create New Account</a
          >
        </p>
      </div>
    </div>
  </body>
  <script type="module">
    import { loginWithEmailPassword } from './services/login.js';
    const regex = {
      email: /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,
      password:
        /^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,36}$/,
    };

    // Emoji or non-ASCII checker
    function containsOnlyASCII(str) {
      return /^[\x00-\x7F]*$/.test(str);
    }
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const emailError = document.getElementById('emailError');
    const emailSuccess = document.getElementById('emailSuccess');
    const passwordError = document.getElementById('passwordError');
    const passwordSuccess = document.getElementById('passwordSuccess');
    const submitBtn = document.getElementById('submitBtn');
    function validateEmail(email) {
      if (!email) {
        return { isValid: false, message: 'Email is required' };
      }
      if (!containsOnlyASCII(email)) {
        return {
          isValid: false,
          message: 'Email must not contain emojis or non-English characters.',
        };
      }
      if (!regex.email.test(email)) {
        return {
          isValid: false,
          message: 'Please enter a valid Email Address.',
        };
      }
      return { isValid: true, message: '' };
    }

    function validatePassword(password) {
      if (!password) {
        return { isValid: false, message: 'Password is required' };
      }
      if (!containsOnlyASCII(password)) {
        return {
          isValid: false,
          message:
            'Password must not contain emojis or unsupported characters.',
        };
      }
      if (password.length < 8) {
        return {
          isValid: false,
          message: 'Password must be at least 8 characters.',
        };
      }
      if (password.length > 36) {
        return {
          isValid: false,
          message: 'Password must be at most 36 characters',
        };
      }
      if (!regex.password.test(password)) {
        return {
          isValid: false,
          message:
            'Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character.',
        };
      }
      return { isValid: true, message: '' };
    }
    // show validation

    function showValidation(input, errorElement, successElement, validation) {
      if (validation.isValid) {
        input.classList.remove('input-error');
        input.classList.add('input-success');
        errorElement.classList.remove('show');
        successElement.textContent = validation.message;
        successElement.classList.add('show');
      } else {
        input.classList.remove('input-success');
        input.classList.add('input-error');
        successElement.classList.remove('show');
        errorElement.textContent = validation.message;
        errorElement.classList.add('show');
      }
    }
    // toggle password visibility

    const togglePassword = document.getElementById('togglePassword');
    const eyeOpen = document.getElementById('eyeOpen');
    const eyeClosed = document.getElementById('eyeClosed');

    togglePassword.addEventListener('click', function () {
      const type =
        passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      eyeOpen.classList.toggle('hidden');
      eyeClosed.classList.toggle('hidden');
    });

    // real time validation

    emailInput.addEventListener('input', function () {
      const emailValidate = validateEmail(this.value.trim());
      showValidation(emailInput, emailError, emailSuccess, emailValidate);
    });
    emailInput.addEventListener('blur', function () {
      const emailValidate = validateEmail(this.value.trim());
      showValidation(emailInput, emailError, emailSuccess, emailValidate);
    });
    passwordInput.addEventListener('input', function () {
      const passwordValidate = validatePassword(this.value);
      showValidation(
        passwordInput,
        passwordError,
        passwordSuccess,
        passwordValidate,
      );
    });
    passwordInput.addEventListener('blur', function () {
      const passwordValidate = validatePassword(this.value);
      showValidation(
        passwordInput,
        passwordError,
        passwordSuccess,
        passwordValidate,
      );
    });
    const inputContainer = document.querySelectorAll('.input-container');

    document.querySelector('form').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      const emailValidate = validateEmail(email);
      const passwordValidate = validatePassword(password);

      showValidation(emailInput, emailError, emailSuccess, emailValidate);
      showValidation(
        passwordInput,
        passwordError,
        passwordSuccess,
        passwordValidate,
      );

      const emailContainer = emailInput.closest('.input-container');
      const passwordContainer = passwordInput.closest('.input-container');

      let hasError = false;

      if (!emailValidate.isValid) {
        hasError = true;
        emailContainer.classList.add('shake');
        emailContainer.addEventListener(
          'animationend',
          () => emailContainer.classList.remove('shake'),
          { once: true },
        );
      }

      if (!passwordValidate.isValid) {
        hasError = true;
        passwordContainer.classList.add('shake');
        passwordContainer.addEventListener(
          'animationend',
          () => passwordContainer.classList.remove('shake'),
          { once: true },
        );
      }

      if (hasError) {
        return;
      }

      const { error } = await loginWithEmailPassword(email, password);

      if (error) {
        alert(`Error: ${error.message}`);
      } else {
        // redirect after successful login
        window.location.href = '/events.html';
      }
    });
  </script>
  <link href="../../style.css" rel="stylesheet" type="text/css" />
</html>
